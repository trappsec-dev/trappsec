# API Reference

This reference documents the core classes and methods available in the Trappsec SDK.

## Sentry

The main entry point for the library.

{% if page.language == 'python' %}
### `Sentry(app, service: str, environment: str)`
{% elsif page.language == 'node' %}
### `new Sentry(app, service, environment)`
{% endif %}

Initializes the Trappsec Sentry.

*   **app**: The application instance (Flask/FastAPI/Express).
*   **service**: Name of your service (e.g., "PaymentService").
*   **environment**: Deployment environment (e.g., "Production", "Staging").

## TrapBuilder

Returned by `ts.trap(path)`. Used to configure a decoy route.

### `methods`

{% if page.language == 'python' %}
```python
trap.methods("GET", "POST")
```
{% elsif page.language == 'node' %}
```javascript
trap.methods("GET", "POST");
```
{% endif %}

Specifies the HTTP methods this trap should accept. Defaults to `["GET", "POST"]`.

### `intent`

{% if page.language == 'python' %}
```python
trap.intent("Credential Harvesting")
```
{% elsif page.language == 'node' %}
```javascript
trap.intent("Credential Harvesting");
```
{% endif %}

Sets the intent label for alerts generated by this trap.

### `respond`

Configures the response sent to authenticated requests (or all requests if `if_unauthenticated` is not set).

**Signature**

{% if page.language == 'python' %}
```python
trap.respond(status: int, body: dict | Callable, mime_type: str = None, template: str = None)
```
{% elsif page.language == 'node' %}
```javascript
trap.respond({ status: number, body: object | Function, mime_type: string, template: string })
```
{% endif %}

**Examples**

{% if page.language == 'python' %}
```python
trap.respond(200, {"status": "ok"})
trap.respond(template="deprecated_api")
```
{% elsif page.language == 'node' %}
```javascript
trap.respond({ status: 200, body: { "status": "ok" } });
trap.respond({ template: "deprecated_api" });
```
{% endif %}

*   **status**: HTTP status code.
*   **body**: JSON body or a function returning a JSON body.
*   **mime_type**: Content-Type header (defaults to "application/json").
*   **template**: Name of a registered response template.

### `if_unauthenticated`

Configures a specific response for unauthenticated requests. Overrides `respond` for unauthenticated traffic.

**Signature**

{% if page.language == 'python' %}
```python
trap.if_unauthenticated(status: int, body: dict | Callable, mime_type: str = None, template: str = None)
```
{% elsif page.language == 'node' %}
```javascript
trap.if_unauthenticated({ status: number, body: object | Function, mime_type: string, template: string })
```
{% endif %}

**Example**

{% if page.language == 'python' %}
```python
trap.if_unauthenticated(401, {"error": "Login Required"})
```
{% elsif page.language == 'node' %}
```javascript
trap.if_unauthenticated({ status: 401, body: { "error": "Login Required" } });
```
{% endif %}

## WatchBuilder

Returned by `ts.watch(path)`. Used to configure honey fields on legitimate routes.

### `body`

Monitors the request body for specific keys.

**Signature**

{% if page.language == 'python' %}
```python
watch.body(name: str, default: Any = NO_DEFAULT, intent: str = None)
```
{% elsif page.language == 'node' %}
```javascript
watch.body(name, { defaultValue: any, intent: string })
```
{% endif %}

**Example**

{% if page.language == 'python' %}
```python
watch.body("is_admin", default=False, intent="PrivEsc")
```
{% elsif page.language == 'node' %}
```javascript
watch.body("is_admin", { defaultValue: false, intent: "PrivEsc" });
```
{% endif %}

*   **name**: The field name to watch.
*   **default**: (Optional) If provided, alerts only if the value differs from this default. If omitted, alerts on any presence of the key.
*   **intent**: The intent label for the alert.

## Configuration

Global configuration methods.

### `identify_user`

Registers a callback to extract user identity from the request.

{% if page.language == 'python' %}
```python
ts.identify_user(lambda r: {"id": r.headers.get("x-user-id")})
```
{% elsif page.language == 'node' %}
```javascript
ts.identify_user((req) => ({ "id": req.headers["x-user-id"] }));
```
{% endif %}

### `override_source_ip`

Registers a callback to extract the real client IP (e.g., from `X-Forwarded-For`).

{% if page.language == 'python' %}
```python
ts.override_source_ip(lambda r: r.remote_addr)
```
{% elsif page.language == 'node' %}
```javascript
ts.override_source_ip((req) => req.ip);
```
{% endif %}

### `add_webhook`

Adds a webhook destination for alerts.

{% if page.language == 'python' %}
```python
ts.add_webhook("https://...")
```
{% elsif page.language == 'node' %}
```javascript
ts.add_webhook("https://...");
```
{% endif %}

### `add_otel`

Enables OpenTelemetry integration for alerts.

{% if page.language == 'python' %}
```python
ts.add_otel()
```
{% elsif page.language == 'node' %}
```javascript
ts.add_otel();
```
{% endif %}
